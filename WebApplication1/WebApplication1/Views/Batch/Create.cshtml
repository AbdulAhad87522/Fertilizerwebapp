@{
    ViewData["Title"] = "Add Batch";
}

@model WebApplication1.Models.Batch

<h2>Create Batch</h2>

<form id="batchForm" asp-action="Create" method="post">
    <!-- Row for Batch Info -->
    <div class="row mb-3">
        <div class="col-md-4"
            <label>Batch Name</label>
            <input asp-for="batch_name" id="batchname" style="width:200px;" placeholder="Enter unique batch name" class="form-control" />
            <button type="button" id="checkBatch" class="btn btn-info">Check</button>
        </div>

        <!-- 🔹 Supplier Autocomplete -->
        <div class="col-md-4">
            <label>Supplier</label>
            <input type="text" id="supplierSearch" placeholder="Search supplier..." class="form-control" />
            <input type="hidden" id="supplierId" name="supplier_id" />
        </div>

        <div class="col-md-4">
            <label>Received Date</label>
            <input asp-for="recieved_date" type="date" class="form-control" />
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <label>Total Price</label>
            <input asp-for="total_price" id="totalprice" type="number" class="form-control" />
        </div>
        <div class="col-md-6">
            <label>Paid Amount</label>
            <input asp-for="paid_amount" id="paidprice" type="number" class="form-control" />
        </div>
    </div>

    <hr />
    <h4>Add Products</h4>

    <!-- Row for Product Inputs -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label>Product</label>
            <input type="text" id="productSearch" placeholder="Search product..." class="form-control" />
            <input type="hidden" id="productId" />
        </div>
        <div class="col-md-3">
            <label>Cost Price</label>
            <input type="number" id="costPrice" placeholder="Cost Price" class="form-control" />
        </div>
        <div class="col-md-3">
            <label>Quantity</label>
            <input type="number" id="quantity" placeholder="Quantity" class="form-control" />
        </div>
        <div class="col-md-2">
            <label>&nbsp;</label>
            <button type="button" id="addProduct" class="btn btn-primary w-100">Add</button>
        </div>
    </div>

  


    <!-- Product Table -->
    <table class="table table-bordered mt-3" id="productsTable">
        <thead class="table-light">
            <tr>
                <th>Product</th>
                <th>Cost Price</th>
                <th>Quantity</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button type="submit" id="saveButton" class="btn btn-success">Save Batch</button>

    @if (ViewBag.Message != null)
    {
        <script>
            alert(`@ViewBag.Message`);
        </script>
    }
</form>

@section Scripts {
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

    <script>
        var productIndex = 0;

        // ✅ Supplier autocomplete
               $("#supplierSearch").autocomplete({
            source: '/Supplier/Search',
            minLength: 0,
            select: function (event, ui) {
                $("#supplierSearch").val(ui.item.value); // supplier name
                $("#supplierId").val(ui.item.id);        // supplier_id (✅ important)
                return false;
            }
        });


                $("#checkBatch").click(function () {
            var batchName = $("#batchname").val();
            if (batchName.trim() === "") {
                alert("Please enter a batch name.");
                return;
            }

            $.get("/batch/CheckBatchName", { batchName: batchName }, function (response) {
                if (response.exists) {
                    alert("⚠️ This batch already exists!");
                } else {
                    alert("✅ Batch name is available.");
                }
            });
        });


                // ✅ Restore supplier name if already chosen
        @if (Model != null && Model.supplier_id > 0)
        {
            <text>
                    $(document).ready(function() {
                        $("#supplierId").val("@Model.supplier_id");
                        $("#supplierSearch").val("@Model.SupplierName"); // now works
                    });
            </text>
        }

        // ✅ Restore products table if already added
        @if (Model?.BatchDetails != null && Model.BatchDetails.Any())
        {
            var index = 0;
            foreach (var d in Model.BatchDetails)
            {
                <text>
                            $(document).ready(function() {
                                $("#productsTable tbody").append(
                                    "<tr>" +
                                        "<td>@d.ProductName</td>" +   // now works
                                        "<td>@d.cost_price</td>" +
                                        "<td>@d.quantity_recived</td>" +
                                        '<input type="hidden" name="BatchDetails[@index].product_id" value="@d.product_id" />' +
                                        '<input type="hidden" name="BatchDetails[@index].cost_price" value="@d.cost_price" />' +
                                        '<input type="hidden" name="BatchDetails[@index].quantity_recived" value="@d.quantity_recived" />' +
                                    "</tr>"
                                );
                            });
                </text>
                index++;
            }
        }


        // ✅ Product autocomplete
                $("#productSearch").autocomplete({
            source: '/ProductController1/Search',
            minLength: 0,
            select: function (event, ui) {
                $("#productSearch").val(ui.item.value); // product name
                $("#productId").val(ui.item.id);        // product_id (✅ important)
                return false;
            }
        });


        // ✅ Add product to table and hidden inputs
               // ✅ Add product to table and hidden inputs
               $("#addProduct").click(function (e) {
            e.preventDefault();
            var productId = $("#productId").val();
            var productName = $("#productSearch").val();
            var costPrice = $("#costPrice").val();
            var qty = $("#quantity").val();

            if (!productId || !productName.trim() || !costPrice || !qty) {
                alert("Please fill all fields before adding.");
                return;
            }

            $("#productsTable tbody").append(
                "<tr>" +
                    "<td>" + productName + "</td>" +
                    "<td>" + costPrice + "</td>" +
                    "<td>" + qty + "</td>" +
                    "<td><button type='button' class='btn btn-danger btn-sm deleteRow'>Delete</button></td>" +
                    '<input type="hidden" name="BatchDetails[' + productIndex + '].product_id" value="' + productId + '" />' +
                    '<input type="hidden" name="BatchDetails[' + productIndex + '].cost_price" value="' + costPrice + '" />' +
                    '<input type="hidden" name="BatchDetails[' + productIndex + '].quantity_recived" value="' + qty + '" />' +
                "</tr>"
            );

            productIndex++;

            // reset inputs
            $("#productSearch").val("");
            $("#productId").val("");
            $("#costPrice").val("");
            $("#quantity").val("");
        });



        // ✅ Optional: clear form after save
        $("#saveButton").click(function () {
                if ($("#supplierId").val() === "" || $("#supplierId").val() === "0") {
            alert("Please select a valid supplier from the list.");
            e.preventDefault();
            return;
        }

        if ($("#productsTable tbody tr").length === 0) {
            alert("Please add at least one product.");
            e.preventDefault();
            return;
        }
            // allow form submission, but clear afterwards
            setTimeout(() => {
                $("#batchname").val("");
                $("#supplierSearch").val("");
                $("#supplierId").val("");
                $("#paidprice").val("");
                $("#totalprice").val("");

                $("#productsTable tbody").empty();
            }, 500);
        });
                // ✅ Handle delete button
        $(document).on("click", ".deleteRow", function () {
            $(this).closest("tr").remove();
        });

    </script>
}
