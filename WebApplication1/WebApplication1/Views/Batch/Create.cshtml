@{
    ViewData["Title"] = "Add Batch";
}

@model WebApplication1.Models.Batch

<h2>Create Batch</h2>

<form id="batchForm" asp-action="Create" method="post">
    <!-- Row for Batch Info -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label>Batch Name</label>
            <input asp-for="batch_name" id="batchname" class="form-control" />
        </div>

        <!-- 🔹 Supplier Autocomplete -->
        <div class="col-md-4">
            <label>Supplier</label>
            <input type="text" id="supplierSearch" placeholder="Search supplier..." class="form-control" />
            <input type="hidden" id="supplierId" name="supplier_id" />
        </div>

        <div class="col-md-4">
            <label>Received Date</label>
            <input asp-for="recieved_date" type="date" class="form-control" />
        </div>
    </div>

    <hr />
    <h4>Add Products</h4>

    <!-- Row for Product Inputs -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label>Product</label>
            <input type="text" id="productSearch" placeholder="Search product..." class="form-control" />
            <input type="hidden" id="productId" />
        </div>
        <div class="col-md-3">
            <label>Cost Price</label>
            <input type="number" id="costPrice" placeholder="Cost Price" class="form-control" />
        </div>
        <div class="col-md-3">
            <label>Quantity</label>
            <input type="number" id="quantity" placeholder="Quantity" class="form-control" />
        </div>
        <div class="col-md-2">
            <label>&nbsp;</label>
            <button type="button" id="addProduct" class="btn btn-primary w-100">Add</button>
        </div>
    </div>

    <!-- Product Table -->
    <table class="table table-bordered mt-3" id="productsTable">
        <thead class="table-light">
            <tr>
                <th>Product</th>
                <th>Cost Price</th>
                <th>Quantity</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button type="submit" id="saveButton" class="btn btn-success">Save Batch</button>

    @if (ViewBag.Message != null)
    {
        <script>
            alert(`@ViewBag.Message`);
        </script>
    }
</form>

@section Scripts {
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

    <script>
        var productIndex = 0;

        // ✅ Supplier autocomplete
        $("#supplierSearch").autocomplete({
            source: '/Supplier/Search',
            minLength: 0,
            select: function (event, ui) {
                $("#supplierSearch").val(ui.item.value); // show supplier name
                $("#supplierId").val(ui.item.id);        // hidden supplier id
                return false;
            }
        });

        // ✅ Product autocomplete
        $("#productSearch").autocomplete({
            source: '/ProductController1/Search',
            minLength: 0,
            select: function (event, ui) {
                $("#productSearch").val(ui.item.value); // show product name
                $("#productId").val(ui.item.id);        // hidden product id
                return false;
            }
        });

        // ✅ Add product to table and hidden inputs
        $("#addProduct").click(function (e) {
            e.preventDefault();
            var productId = $("#productId").val();
            var productName = $("#productSearch").val();
            var costPrice = $("#costPrice").val();
            var qty = $("#quantity").val();

            if (!productId || !productName.trim() || !costPrice || !qty) {
                alert("Please fill all fields before adding.");
                return;
            }

                   $("#productsTable tbody").append(
            "<tr>" +
                "<td>" + productName + "</td>" +
                "<td>" + costPrice + "</td>" +
                "<td>" + qty + "</td>" +
                '<input type="hidden" name="BatchDetails[' + productIndex + '].product_id" value="' + productId + '" />' +
                '<input type="hidden" name="BatchDetails[' + productIndex + '].cost_price" value="' + costPrice + '" />' +
                '<input type="hidden" name="BatchDetails[' + productIndex + '].quantity_recived" value="' + qty + '" />' +
            "</tr>"
        );


            productIndex++;

            // reset inputs
            $("#productSearch").val("");
            $("#productId").val("");
            $("#costPrice").val("");
            $("#quantity").val("");
        });

        // ✅ Optional: clear form after save
        $("#saveButton").click(function () {
            // allow form submission, but clear afterwards
            setTimeout(() => {
                $("#batchname").val("");
                $("#supplierSearch").val("");
                $("#supplierId").val("");
                $("#productsTable tbody").empty();
            }, 500);
        });
    </script>
}
